// Backbone.Blazer v0.0.2
!function(a,b){"object"==typeof exports?module.exports=b(require("jquery"),require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["jquery","underscore","backbone"],b):b(a.$,a._,a.Backbone,a)}(this,function(a,b,c){"use strict";c.Blazer={},c.Blazer.Route=function(a){this.options=b.extend({},b.result(this,"options"),a),this.initialize.apply(this,arguments)},c.Blazer.Route.extend=c.Model.extend,b.extend(c.Blazer.Route.prototype,c.Events,{initialize:function(){},destroy:function(){return this.stopListening(),this},prepare:function(){},execute:function(){},error:function(){},redirect:function(a){return{redirectFragment:a}},prependFilter:function(a,d){this.filters=this.filters||[];var e=c.Blazer.Router.createFilter(a,d);b.isEmpty(e)||this.filters.unshift(e)},appendFilter:function(a,d){this.filters=this.filters||[];var e=c.Blazer.Router.createFilter(a,d);b.isEmpty(e)||this.filters.push(e)}}),c.Blazer.Router=c.Router.extend({constructor:function(){c.Router.apply(this,arguments),this.namedRoutes={},this.routeHandlers={}},route:function(a,d,e){arguments.length<3&&(e=d,d=a,a=b.isString(d)?d.replace(/\/[:\*]?/g,"-").toLowerCase():null),b.isEmpty(a)||(this.namedRoutes[a]&&console.warn("Route `%s` already assigned: %s",a,this.namedRoutes[a]),b.isString(d)&&(this.namedRoutes[a]=d),e instanceof c.Blazer.Route&&(this.routeHandlers[a]=e)),b.isRegExp(d)||(d=this._routeToRegExp(d));var f={handler:e,router:this};a&&this.namedRoutes[a]&&(f.route=this.namedRoutes[a],f.name=a,f.url=this.get.bind(this,a));var g=this;return c.history.route(d,function(a){if(f.params=g._extractParameters(d,a),f.parameters={},b.isString(f.route)&&!b.isEmpty(f.params)){var c=[];f.route.replace(/\/[:\*](\w+)/g,function(a,b){c.push(b)}),f.parameters=b.object(c,f.params.slice(0,c.length))}g.handleRoute(f)}),this},navigateTo:function(a,b,c){var d=this.get(a,b);return this.navigate(d,c)},get:function(a,c){var d=this.namedRoutes[a];return b.isString(d)&&arguments.length>1&&(d=this.url(d,c)),d},handler:function(a){return this.routeHandlers[a]},handleRoute:function(a){function d(){var b=f.current.route,d=a.params||[];f.trigger.apply(f,["route:"+b].concat(d)),f.trigger("route",b,d),c.history.trigger("route",f,b,d)}var e=a.handler,f=this;if(this.previous=this.current?this.current:null,this.current={},this.current.handler=e,this.current.name=b.isString(a.name)?a.name:"",this.current.route=a.route||"",this.current.url=b.isFunction(a.url)?a.url(a.params||[]):"",this.current.parameters=a.parameters||{},b.isString(e))b.isFunction(this[e])&&(this[e].apply(this,a.params),d());else if(e instanceof c.Blazer.Route)this._handleBlazerRoute(e,a,d);else{if(!b.isFunction(e))throw new Error("Incorrectly configured route");e.apply(this,a)}},url:function(a,c){c=b.isObject(c)&&!b.isArray(c)?c:arguments.length>1?b.flatten(b.rest(arguments)):{};var d=0;return a=(a+"").replace(/[\(\)]/g,""),a.replace(/\/[:\*](\w+)/g,function(a,e){var f=c[e]||c[d++];return b.isUndefined(f)?"":"/"+f})},matchesUrl:function(a,c){return arguments.length>1&&(a=this.url(a,c)),b.isString(this.current.url)&&0===a.indexOf(this.current.url)},ancestors:function(a,c){0===arguments.length?(a=this.current&&this.current.name||"",c=this.current&&this.current.parameters||{}):b.isObject(a)&&(c=b.extend({},a),a=this.current&&this.current.name||"");for(var d=[],e=a.split(".");e.length;){var f=e.join("."),g=this.get(f);if(g){var h=this.url(g,c);d.push({name:f,route:g,url:h})}e.pop()}return d.reverse()},nodes:function(a,c){0===arguments.length?(a=this.current&&this.current.name||"",c=this.current&&this.current.parameters||{}):b.isObject(a)&&(c=b.extend({},a),a=this.current&&this.current.name||"");var d=[],e=a+".";return b.each(b.keys(this.routeHandlers),function(a){if(0===a.indexOf(e)){var b=this.get(a);if(b){var f=this.url(b,c);d.push({name:a,route:b,url:f})}}}.bind(this)),d},siblings:function(a,c){0===arguments.length?(a=this.current&&this.current.name||"",c=this.current&&this.current.parameters||{}):b.isObject(a)&&(c=b.extend({},a),a=this.current&&this.current.name||"");var d=[],e=a.split(".").slice(0,-1),f=e.join(".")+".",g=a+".";return b.each(b.keys(this.routeHandlers),function(b){if(0===b.indexOf(f)&&-1===b.indexOf(g)){var e=this.get(b);if(e){var h=this.url(e,c),i=b===a;d.push({name:b,route:e,url:h,active:i})}}}.bind(this)),d},_handleBlazerRoute:function(a,c,d){var e=this;a.trigger("before:execute",c,a),e.trigger("before:execute",c,a),this._runBeforeFilters(e,a,c).then(function(){return e._runHandler(a.prepare,e,a,c)}).then(function(){e.current&&e.current.handler!==a||(e._runHandler(a.execute,e,a,c),b.isFunction(d)&&d(c,a),a.trigger("after:execute",c,a),e.trigger("after:execute",c,a),e._runAfterFilters(e,a,c))}).fail(function(){if(!e.current||e.current.handler===a){var b=Array.prototype.slice.call(arguments);b.unshift(c);var d;e._runHandler(function(){var c=a.error.apply(a,b);return d=c===!0,c},e,a,c),d||e.trigger("error",b)}})},_runBeforeFilters:function(a,b,c){return this._runFilters("beforeRoute",a,b,c)},_runAfterFilters:function(a,b,c){return this._runFilters("afterRoute",a,b,c)},_runFilters:function(c,d,e,f){var g=(this.filters||[]).concat(e.filters||[]),h=b.compact(b.pluck(g,c)),i=a.Deferred(),j=b.reduce(h,function(a,b){return a?a.then(function(){return d._runHandler(b,d,e,f)}):d._runHandler(b,d,e,f)},null);return j?j.then(i.resolve):i.resolve(),i.promise()},_runHandler:function(b,c,d,e){var f=b.call(d,e);return f&&f.redirectFragment?(c.navigate(f.redirectFragment,{trigger:!0}),a.Deferred().reject().promise()):a.when(f)}},{filters:{},registerFilter:function(a,c){b.isFunction(c)&&(this.filters[a]=c)},createFilter:function(a,c){var d={};return b.isString(a)&&(a=this.filters[a]),b.isString(c)&&(a=this.filters[c]),b.isFunction(a)&&(d.beforeRoute=a),b.isFunction(c)&&(d.afterRoute=c),d}})});
//# sourceMappingURL=backbone.blazer.min.js.map