// Backbone.Blazer v0.0.2
!function(a,b){"object"==typeof exports?module.exports=b(require("jquery"),require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["jquery","underscore","backbone"],b):b(a.$,a._,a.Backbone,a)}(this,function(a,b,c){"use strict";c.Blazer={},c.Blazer.Route=function(a){this.options=b.extend({},b.result(this,"options"),a),this.initialize.apply(this,arguments)},c.Blazer.Route.extend=c.Model.extend,b.extend(c.Blazer.Route.prototype,c.Events,{initialize:function(){},destroy:function(){return this.stopListening(),this},prepare:function(){},execute:function(){},exit:function(){},error:function(){},canNavigate:function(){},redirect:function(a){return{redirectFragment:a}},prependFilter:function(a,d){this.filters=this.filters||[];var e=c.Blazer.Router.createFilter(a,d);b.isEmpty(e)||this.filters.unshift(e)},appendFilter:function(a,d){this.filters=this.filters||[];var e=c.Blazer.Router.createFilter(a,d);b.isEmpty(e)||this.filters.push(e)}}),c.Blazer.Section=c.Blazer.Route.extend({constructor:function(a){this.router=new c.Blazer.Router(a),this.router.options.history=!1,this.on("before:execute",function(a){a.section=this})},execute:function(a){this.router.executeUrl(a.parameters.path||"")},route:function(a,b,c){return this.router.route(a,b,c)}}),c.Blazer.Router=c.Router.extend({constructor:function(a){c.Router.apply(this,arguments),this.options=b.extend({},b.result(this,"options"),a),this.namedRoutes={},this.routeHandlers={},this.handlers=[]},route:function(a,d,e){arguments.length<3&&(e=d,d=a,a=b.isString(d)?d.replace(/\/[:\*]?/g,"-").toLowerCase():null),b.isEmpty(a)||(this.namedRoutes[a]&&console.warn("Route `%s` already assigned: %s",a,this.namedRoutes[a]),b.isString(d)&&(this.namedRoutes[a]=d),e instanceof c.Blazer.Route&&(this.routeHandlers[a]=e)),b.isRegExp(d)||(d=this._routeToRegExp(d));var f=this,g={handler:e,router:this};a&&b.has(this.namedRoutes,a)&&(g.route=this.namedRoutes[a],g.name=a,g.url=function(c){var d=b.extend({},g.parameters);return c=b.isArray(c)?c:b.isObject(c)?b.extend(d,c):d,g.router.getUrl(a,c)});var h=function(a){if(g=b.extend({},g),g.params=f._extractParameters(d,a),g.parameters={},b.isString(g.route)&&!b.isEmpty(g.params)){var c=[];g.route.replace(/\/[:\*](\w+)/g,function(a,b){c.push(b)}),g.parameters=b.object(c,g.params.slice(0,c.length))}f.handleRoute(g)};return this.handlers.push({route:d,callback:h}),this.options.history!==!1&&c.history.route(d,h),this},section:function(a,d,e){b.isObject(d)&&(e=d,d=null),b.isString(d)||(d=a),e=b.extend({root:d},e);var f=d+"(/*path)",g=new c.Blazer.Section(e);return this.route(a,f,g),g},executeRoute:function(a,b){return this.executeUrl(this.getUrl(a,b))},executeUrl:function(a){return b.any(this.handlers,function(b){return b.route.test(a)?(b.callback(a),!0):void 0})},navigate:function(a,b){return b=b||{},this.canNavigate(a,b)===!1||this.previous&&this.previous.handler instanceof c.Blazer.Route&&this.previous.handler.canNavigate(a,b,this)===!1||this.current&&this.current.handler instanceof c.Blazer.Route&&this.current.handler.canNavigate(a,b,this)===!1?void 0:c.Router.prototype.navigate.call(this,a,b)},navigateTo:function(a,b,c){var d=this.get(a,b);return this.navigate(d,c)},get:function(a){return b.isString(a)&&arguments.length>1?this.getUrl.apply(this,arguments):this.namedRoutes[a]},getUrl:function(a){var c=this.options.root||"",d=this.namedRoutes[a];if(b.isString(d)){var e=b.rest(arguments),f=this.url.apply(this,[d].concat(e));return b.isEmpty(f)?c:b.isEmpty(c)?f:c+"/"+f}return c},handler:function(a){return this.routeHandlers[a]},handleRoute:function(a){function d(){var b=f.current.route,d=a.params||[];f.trigger.apply(f,["route:"+b].concat(d)),f.trigger("route",b,d),c.history.trigger("route",f,b,d)}var e=a.handler,f=this,g=this.current?this.current:null,h={};if(h.router=f,h.handler=e,h.name=b.isString(a.name)?a.name:"",h.route=a.route||"",h.url=b.isFunction(a.url)?a.url(a.params||[]):"",h.params=a.params||[],h.parameters=a.parameters||{},this.previous=g,this.current=h,b.isString(e))b.isFunction(this[e])&&(this[e].apply(this,a.params),d());else if(e instanceof c.Blazer.Route)this._handleBlazerRoute(e,a,d);else{if(!b.isFunction(e))throw new Error("Incorrectly configured route");e.apply(this,a)}},canNavigate:function(){},url:function(a,c){c=b.isObject(c)&&!b.isArray(c)?c:arguments.length>1?b.flatten(b.rest(arguments)):{};var d=0;return a=(a+"").replace(/[\(\)]/g,""),a.replace(/\/[:\*](\w+)/g,function(a,e){var f=c[e]||c[d++];return b.isUndefined(f)||b.isNull(f)?"":"/"+f})},matchesUrl:function(a,c){return arguments.length>1&&(a=this.url(a,c)),this.current?""===this.current.url&&this.current.url===a?!0:""===this.current.url?!1:b.isString(this.current.url)&&b.isString(a)&&this.current.url===a:""===a},matchesRoute:function(a,b){return this.matchesUrl(this.get(a,b))},isAncestor:function(a){var c=this.current&&this.current.name;return c&&b.isString(a)&&0===c.indexOf(a+".")},ancestors:function(a,c){0===arguments.length?(a=this.current&&this.current.name||"",c=this.current&&this.current.parameters||{}):b.isObject(a)&&(c=b.extend({},a),a=this.current&&this.current.name||"");for(var d=[],e=a.split(".");e.length;){var f=e.join("."),g=this.get(f);if(g){var h=this.url(g,c);d.push({name:f,route:g,url:h})}e.pop()}return d.reverse()},nodes:function(a,c){0===arguments.length?(a=this.current&&this.current.name||"",c=this.current&&this.current.parameters||{}):b.isObject(a)&&(c=b.extend({},a),a=this.current&&this.current.name||"");var d=[],e=a+".";return b.each(b.keys(this.routeHandlers),function(a){if(0===a.indexOf(e)){var b=this.get(a);if(b){var f=this.url(b,c);d.push({name:a,route:b,url:f})}}}.bind(this)),d},siblings:function(a,c){0===arguments.length?(a=this.current&&this.current.name||"",c=this.current&&this.current.parameters||{}):b.isObject(a)&&(c=b.extend({},a),a=this.current&&this.current.name||"");var d=[],e=a.split(".").slice(0,-1),f=e.join(".")+".",g=a+".";return b.each(b.keys(this.routeHandlers),function(b){if(0===b.indexOf(f)&&-1===b.indexOf(g)){var e=this.get(b);if(e){var h=this.url(e,c),i=b===a;d.push({name:b,route:e,url:h,active:i})}}}.bind(this)),d},_handleBlazerRoute:function(c,d,e){var f,g=this,h=this.previous&&this.previous.handler;c.trigger("before:execute",d,c),g.trigger("before:execute",d,c),f=h&&b.isFunction(h.exit)?g._runHandler(h.exit,g,h,d):a.Deferred().resolve().promise(),f.then(function(){return g._runBeforeFilters(g,c,d)}).then(function(){return g._runHandler(c.prepare,g,c,d)}).then(function(){g.current&&g.current.handler!==c||(g._runHandler(c.execute,g,c,d),b.isFunction(e)&&e(d,c),c.trigger("after:execute",d,c),g.trigger("after:execute",d,c),g._runAfterFilters(g,c,d))}).fail(function(a){if(a instanceof Error&&(d.error=a),!g.current||g.current.handler===c){g._cancelRoute(g,c,d);var b=Array.prototype.slice.call(arguments);b.unshift(d);var e;g._runHandler(function(){var a=c.error.apply(c,b);return e=a===!0,a},g,c,d),e||g.trigger("error",b)}})},_cancelRoute:function(a,b,c){b.trigger("before:cancel",c,b),a.trigger("before:cancel",c,b),a.current=a.previous;var d=a.previous&&a.previous.url;a.navigate(d||"",{replace:!0}),b.trigger("after:cancel",c,b),a.trigger("after:cancel",c,b)},_runBeforeFilters:function(a,b,c){return this._runFilters("beforeRoute",a,b,c)},_runAfterFilters:function(a,b,c){return this._runFilters("afterRoute",a,b,c)},_runFilters:function(c,d,e,f){var g=(this.filters||[]).concat(e.filters||[]),h=b.compact(b.pluck(g,c)),i=a.Deferred(),j=b.reduce(h,function(a,b){return a?a.then(function(){return d._runHandler(b,d,e,f)}):d._runHandler(b,d,e,f)},null);return j?j.then(i.resolve):i.resolve(),i.promise()},_runHandler:function(b,c,d,e){var f=b.call(d,e);return f&&f.redirectFragment?(c.navigate(f.redirectFragment,{trigger:!0}),a.Deferred().reject().promise()):f===!1?(c._cancelRoute(c,d,e),a.Deferred().reject().promise()):a.when(f)}},{filters:{},registerFilter:function(a,c){b.isFunction(c)&&(this.filters[a]=c)},createFilter:function(a,c){var d={};return b.isString(a)&&(a=this.filters[a]),b.isString(c)&&(a=this.filters[c]),b.isFunction(a)&&(d.beforeRoute=a),b.isFunction(c)&&(d.afterRoute=c),d}})});
//# sourceMappingURL=backbone.blazer.min.js.map